import*as e from"react";import{useMountEffect as r,useUpdateEffect as n}from"primereact/hooks";import{InputText as t}from"primereact/inputtext";import{DomHandler as u,ObjectUtils as c,classNames as a}from"primereact/utils";import{ComponentBase as l}from"primereact/componentbase";import{PrimeReactContext as o}from"primereact/api";function i(){return i=Object.assign?Object.assign.bind():function(e){for(var r=1;r<arguments.length;r++){var n=arguments[r];for(var t in n)Object.prototype.hasOwnProperty.call(n,t)&&(e[t]=n[t])}return e},i.apply(this,arguments)}var s=l.extend({defaultProps:{__TYPE:"InputMask",autoClear:!0,autoFocus:!1,className:null,disabled:!1,id:null,mask:null,maxLength:null,name:null,onBlur:null,onChange:null,onComplete:null,onFocus:null,placeholder:null,readOnly:!1,required:!1,size:null,slotChar:"_",style:null,tabIndex:null,tooltip:null,tooltipOptions:null,type:"text",unmask:!1,value:null,children:void 0}}),f=e.memo(e.forwardRef((function(l,f){var v=e.useContext(o),m=s.getProps(l,v),p=e.useRef(f),g=e.useRef(null),d=e.useRef(0),h=e.useRef([]),b=e.useRef([]),C=e.useRef(0),k=e.useRef(null),y=e.useRef(!1),R=e.useRef(null),E=e.useRef(null),x=e.useRef(null),O=e.useRef(null),P=e.useRef(null),I=e.useRef(!1),S=function(e,r){var n,t,u,c=p.current;if(c&&c.offsetParent&&c===document.activeElement)return"number"!=typeof e?(c.setSelectionRange?(t=c.selectionStart,u=c.selectionEnd):document.selection&&document.selection.createRange&&(u=(t=0-(n=document.selection.createRange()).duplicate().moveStart("character",-1e5))+n.text.length),{begin:t,end:u}):(t=e,u="number"==typeof r?r:t,void(c.setSelectionRange?c.setSelectionRange(t,u):c.createTextRange&&((n=c.createTextRange()).collapse(!0),n.moveEnd("character",u),n.moveStart("character",t),n.select())))},T=function(){for(var e=g.current;e<=d.current;e++)if(h.current[e]&&b.current[e]===j(e))return!1;return!0},j=e.useCallback((function(e){return m.slotChar.charAt(e<m.slotChar.length?e:0)}),[m.slotChar]),A=function(){return m.unmask?_():p.current&&p.current.value},F=function(e){for(;++e<C.current&&!h.current[e];);return e},w=function(e){for(;--e>=0&&!h.current[e];);return e},D=function(e,r){var n,t;if(!(e<0)){for(n=e,t=F(r);n<C.current;n++)if(h.current[n]){if(!(t<C.current&&h.current[n].test(b.current[t])))break;b.current[n]=b.current[t],b.current[t]=j(t),t=F(t)}M(),S(Math.max(g.current,e))}},z=function(e){var r,n,t,u;for(r=e,n=j(e);r<C.current;r++)if(h.current[r]){if(t=F(r),u=b.current[r],b.current[r]=n,!(t<C.current&&h.current[t].test(u)))break;n=u}},K=function(e){var r=p.current.value,n=S();if(k.current.length&&k.current.length>r.length){for(N(!0);n.begin>0&&!h.current[n.begin-1];)n.begin--;if(0===n.begin)for(;n.begin<g.current&&!h.current[n.begin];)n.begin++;S(n.begin,n.begin)}else{for(N(!0);n.begin<C.current&&!h.current[n.begin];)n.begin++;S(n.begin,n.begin)}m.onComplete&&T()&&m.onComplete({originalEvent:e,value:A()}),H(e)},B=function(e){if(y.current=!1,N(),H(e),Z(),m.onBlur&&m.onBlur(e),p.current.value!==R.current){var r=document.createEvent("HTMLEvents");r.initEvent("change",!0,!1),p.current.dispatchEvent(r)}},L=function(e,r){var n;for(n=e;n<r&&n<C.current;n++)h.current[n]&&(b.current[n]=j(n))},M=function(){p.current.value=b.current.join("")},N=function(e){E.current=!0;var r,n,t,u=p.current.value,c=-1;for(r=0,t=0;r<C.current;r++)if(h.current[r]){for(b.current[r]=j(r);t++<u.length;)if(n=u.charAt(t-1),h.current[r].test(n)){b.current[r]=n,c=r;break}if(t>u.length){L(r+1,C.current);break}}else b.current[r]===u.charAt(t)&&t++,r<x.current&&(c=r);return e?M():c+1<x.current?m.autoClear||b.current.join("")===O.current?(p.current.value&&(p.current.value=""),L(0,C.current)):M():(M(),p.current.value=p.current.value.substring(0,c+1)),x.current?r:g.current},q=function(e){if(!m.readOnly){var r=N(!0);S(r),H(e),m.onComplete&&T()&&m.onComplete({originalEvent:e,value:A()})}},_=e.useCallback((function(){for(var e=[],r=0;r<b.current.length;r++){var n=b.current[r];h.current[r]&&n!==j(r)&&e.push(n)}return e.join("")}),[j]),H=function(e){if(m.onChange){var r=m.unmask?_():e&&e.target.value;m.onChange({originalEvent:e,value:O.current!==r?r:"",stopPropagation:function(){e.stopPropagation()},preventDefault:function(){e.preventDefault()},target:{name:m.name,id:m.id,value:O.current!==r?r:""}})}},Z=function(){p.current&&p.current.value&&p.current.value.length>0?u.addClass(p.current,"p-filled"):u.removeClass(p.current,"p-filled")},Y=function(e){var r;return p.current&&(null==m.value?p.current.value="":(p.current.value=m.value,r=N(e),setTimeout((function(){if(p.current)return M(),N(e)}),10)),R.current=p.current.value),Z(),r},G=e.useCallback((function(){return m.unmask?m.value!==_():O.current!==p.current.value&&p.current.value!==m.value}),[m.unmask,m.value,_]),J=function(){if(m.mask){h.current=[],x.current=m.mask.length,C.current=m.mask.length,g.current=null;var e={9:"[0-9]",a:"[A-Za-z]","*":"[A-Za-z0-9]"};I.current=u.isChrome()&&u.isAndroid();for(var r=m.mask.split(""),n=0;n<r.length;n++){var t=r[n];"?"===t?(C.current--,x.current=n):e[t]?(h.current.push(new RegExp(e[t])),null===g.current&&(g.current=h.current.length-1),n<x.current&&(d.current=h.current.length-1)):h.current.push(null)}b.current=[];for(var c=0;c<r.length;c++){var a=r[c];"?"!==a&&b.current.push(e[a]?j(c):a)}O.current=b.current.join("")}};e.useImperativeHandle(f,(function(){return{props:m,focus:function(){return u.focus(p.current)},getElement:function(){return p.current}}})),e.useEffect((function(){c.combinedRefs(p,f)}),[p,f]),r((function(){J(),Y()})),n((function(){J(),S(Y(!0)),m.unmask&&H()}),[m.mask]),n((function(){G()&&Y()}),[G]);var Q=s.getOtherProps(m),U=a("p-inputmask",m.className);return e.createElement(t,i({ref:p,autoFocus:m.autoFocus,id:m.id,type:m.type,name:m.name,style:m.style,className:U},Q,{placeholder:m.placeholder,size:m.size,maxLength:m.maxLength,tabIndex:m.tabIndex,disabled:m.disabled,readOnly:m.readOnly,onFocus:function(e){var r;m.readOnly||(y.current=!0,clearTimeout(P.current),R.current=p.current.value,r=N(),P.current=setTimeout((function(){p.current===document.activeElement&&(M(),r===m.mask.replace("?","").length?S(0,r):S(r),Z())}),10),m.onFocus&&m.onFocus(e))},onBlur:B,onKeyDown:function(e){if(!m.readOnly){var r,n,t,c=e.which||e.keyCode;k.current=p.current.value,8===c||46===c||u.isIOS()&&127===c?((t=(r=S()).end)-(n=r.begin)==0&&(n=46!==c?w(n):t=F(n-1),t=46===c?F(t):t),L(n,t),D(n,t-1),H(e),e.preventDefault()):13===c?(B(e),H(e)):27===c&&(p.current.value=R.current,S(0,N()),H(e),e.preventDefault())}},onKeyPress:function(e){if(!m.readOnly){var r,n,t,c,a=e.which||e.keyCode,l=S();if(!(e.ctrlKey||e.altKey||e.metaKey||a<32)){if(a&&13!==a){if(l.end-l.begin!=0&&(L(l.begin,l.end),D(l.begin,l.end-1)),(r=F(l.begin-1))<C.current&&(n=String.fromCharCode(a),h.current[r].test(n))){if(z(r),b.current[r]=n,M(),t=F(r),u.isAndroid()){setTimeout((function(){S(t)}),0)}else S(t);l.begin<=d.current&&(c=T())}e.preventDefault()}H(e),m.onComplete&&c&&m.onComplete({originalEvent:e,value:A()})}}},onInput:function(e){I.current?K(e):q(e)},onPaste:q,required:m.required,tooltip:m.tooltip,tooltipOptions:m.tooltipOptions,pt:m.pt}))})));f.displayName="InputMask";export{f as InputMask};
